(()=>{"use strict";const e={baseUrl:"https://nomoreparties.co/v1/wff-cohort-30",headers:{authorization:"ef6f4971-986f-4940-9ee3-c61b74980adb","Content-Type":"application/json"}},t=e=>e.ok?e.json():Promise.reject(`Ошибка ${e.status}`);function r(e,{removeCard:t,toggleLikeCallback:r,openImagePopup:o,userId:n}){try{const a=document.querySelector("#card-template")?.content;if(!a)return void console.error(" Ошибка: Не найден шаблон #card-template");const c=a.querySelector(".card").cloneNode(!0);if(!c)return void console.error(" Ошибка: Не найден .card в шаблоне");const l=c.querySelector(".card__image"),s=c.querySelector(".card__like-count"),i=c.querySelector(".card__title");if(!l||!s||!i)return void console.error(" Ошибка: Отсутствуют элементы карточки");l.setAttribute("src",e.link),l.setAttribute("alt",e.name),i.textContent=e.name,s.textContent=e.likes.length,l.addEventListener("click",(()=>{o(e.link,e.name)}));const u=c.querySelector(".card__like-button");u.addEventListener("click",(()=>{r(u,e._id,s)}));e.likes.some((e=>e._id===n))&&u.classList.add("card__like-button_is-active");const d=c.querySelector(".card__delete-button");return e.owner._id!==n?d.remove():d.addEventListener("click",(()=>{t(c,e._id)})),c}catch(e){console.error("Ошибка в createNewCard:",e)}}function o(r,o,n){((r,o)=>fetch(`${e.baseUrl}/cards/likes/${r}`,{method:o?"DELETE":"PUT",headers:e.headers}).then(t))(o,r.classList.contains("card__like-button_is-active")).then((e=>{r.classList.toggle("card__like-button_is-active"),n.textContent=e.likes.length})).catch((e=>console.log(e)))}function n(r,o){(r=>fetch(`${e.baseUrl}/cards/${r}`,{method:"DELETE",headers:e.headers}).then(t))(o).then((()=>{r.remove()})).catch((e=>{console.log(`Ошибка во время удаления карточки: ${e}`)}))}const a=(e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);r.forEach((r=>l(e,r,t))),u(r,o,t)},c=(e,t,r,o)=>{const n=e.querySelector(`.${t.id}-error`);n?(t.classList.add(o.inputErrorClass),n.textContent=r,n.classList.add(o.errorClass)):console.error(`Элемент с ошибкой для ${t.id} не найден`)},l=(e,t,r)=>{const o=e.querySelector(`.${t.id}-error`);o?(t.classList.remove(r.inputErrorClass),t.setCustomValidity(""),o.classList.remove(r.errorClass),o.textContent=""):console.error(`Элемент с ошибкой для ${t.id} не найден`)},s=(e,t,r)=>{if("url"===t.type||t.classList.contains("url-input"))((e,t,r)=>{let o="";console.log("URL input value:",t.value),""===t.value.trim()||/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(t.value.trim())||(o="Введите корректный URL.",console.log("URL validation failed for:",t.value)),t.setCustomValidity(o),o?c(e,t,o,r):l(e,t,r)})(e,t,r);else{const o=/^[a-zA-Zа-яА-ЯёЁ\- ]+$/,n=parseInt(t.getAttribute("minlength"))||2,a=parseInt(t.getAttribute("maxlength"))||200;let s="";console.log("Input value:",t.value),t.value.length<n?s=`Текст должен быть не короче ${n} символов.`:t.value.length>a?s=`Текст должен быть не длиннее ${a} символов.`:""===t.value.trim()||o.test(t.value.trim())||(s="Разрешены только латинские, кириллические буквы, знаки дефиса и пробелы.",console.log("Pattern validation failed for:",t.value)),t.setCustomValidity(s),s?c(e,t,s,r):l(e,t,r)}},i=(e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);u(r,o,t),r.forEach((n=>{n.addEventListener("input",(()=>{s(e,n,t),u(r,o,t)}))}))},u=(e,t,r)=>{(e=>e.some((e=>!e.validity.valid)))(e)?(t.disabled=!0,t.classList.add(r.inactiveButtonClass)):(t.disabled=!1,t.classList.remove(r.inactiveButtonClass))};function d(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",_),e.addEventListener("click",m)}function p(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",_),e.removeEventListener("click",m)}function _(e){if("Escape"===e.key){const e=document.querySelector(".popup_is-opened");e&&p(e)}}function m(e){(e.target===e.currentTarget||e.target.classList.contains("popup__close"))&&p(e.currentTarget)}const v=document.querySelector(".places__list"),y=document.querySelectorAll(".popup__close"),f=document.querySelector(".popup_type_new-card"),h=document.querySelector('.popup__form[name="new-place"]'),S=h.querySelector(".popup__input_type_card-name"),b=h.querySelector(".popup__input_type_url"),g=document.querySelector(".profile__add-button"),q=document.querySelector(".popup_type_edit"),C=document.querySelector('.popup__form[name="edit-profile"]'),L=C.querySelector(".popup__input_type_name"),k=C.querySelector(".popup__input_type_description"),E=document.querySelector(".profile__info"),$=E.querySelector(".profile__title"),x=E.querySelector(".profile__description"),A=E.querySelector(".profile__edit-button"),U=document.querySelector(".popup_type_avatar"),I=document.querySelector('.popup__form[name="edit-avatar"]'),P=document.querySelector(".popup__input_type_avatar"),T=document.querySelector(".profile__image"),w=document.querySelector(".popup_type_image"),B=w.querySelector(".popup__image"),D=w.querySelector(".popup__caption"),N={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};let z=null;function O(e,t){B.src=e,B.alt=t,D.textContent=t,d(w)}function V(e,t=!1){t?v.prepend(e):v.append(e)}const j=(e,t)=>{const r=t.querySelector(".popup__button");e?(r.setAttribute("data-text",r.textContent),r.textContent="Сохранение..."):(r.textContent=r.getAttribute("data-text"),r.removeAttribute("data-text"))};A.addEventListener("click",(()=>{L.value=$.textContent,k.value=x.textContent,a(C,N),d(q)})),g.addEventListener("click",(()=>{h.reset(),a(h,N),d(f)})),T.addEventListener("click",(()=>{I.reset(),a(I,N),d(U)})),y.forEach((e=>{const t=e.closest(".popup");e.addEventListener("click",(()=>{t&&p(t)}))})),C.addEventListener("submit",(function(r){var o,n;r.preventDefault(),j(!0,C),(o=L.value,n=k.value,fetch(`${e.baseUrl}/users/me`,{method:"PATCH",headers:e.headers,body:JSON.stringify({name:o,about:n})}).then(t)).then((e=>{$.textContent=e.name,x.textContent=e.about,p(q)})).catch((e=>{console.error("Ошибка при обновлении профиля:",e)})).finally((()=>j(!1,C)))})),h.addEventListener("submit",(function(a){var c,l;a.preventDefault(),h.checkValidity()&&(j(!0,h),(c=S.value,l=b.value,fetch(`${e.baseUrl}/cards`,{method:"POST",headers:e.headers,body:JSON.stringify({name:c,link:l})}).then(t)).then((e=>{const t=r(e,{removeCard:n,toggleLikeCallback:o,openImagePopup:O,userId:z});t?(V(t,!0),h.reset(),p(f)):console.error("Ошибка: карточка не создана")})).catch((e=>{console.error("Ошибка при создании карточки:",e)})).finally((()=>j(!1,h))))})),I.addEventListener("submit",(function(r){var o;r.preventDefault(),j(!0,I),(o=P.value,fetch(`${e.baseUrl}/users/me/avatar`,{method:"PATCH",headers:e.headers,body:JSON.stringify({avatar:o})}).then(t)).then((({avatar:e})=>{T.style.backgroundImage=`url(${e})`,I.reset(),p(U)})).catch((e=>{console.error("Ошибка при обновлении аватара:",e)})).finally((()=>j(!1,I)))})),Promise.all([fetch(`${e.baseUrl}/users/me`,{headers:e.headers}).then(t),fetch(`${e.baseUrl}/cards`,{headers:e.headers}).then(t)]).then((([e,t])=>{z=e._id,$.textContent=e.name,x.textContent=e.about,T.style.backgroundImage=`url(${e.avatar})`,t.forEach((e=>{V(r(e,{removeCard:n,toggleLikeCallback:o,openImagePopup:O,userId:z}))}))})).catch((e=>{console.error("Ошибка при загрузке данных:",e)})),(e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>i(t,e)))})(N)})();