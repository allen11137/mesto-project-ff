(()=>{"use strict";const e={baseUrl:"https://nomoreparties.co/v1/wff-cohort-30",headers:{authorization:"ef6f4971-986f-4940-9ee3-c61b74980adb","Content-Type":"application/json"}},t=e=>e.ok?e.json():Promise.reject(`Ошибка ${e.status}`);function o(e,t,o,r,n,c,s,a,l){const i=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),u=i.querySelector(".card__image"),d=i.querySelector(".card__like-count");u.setAttribute("src",o),u.setAttribute("alt",t),i.querySelector(".card__title").textContent=t,d.textContent=n.length;const p=i.querySelector(".card__delete-button");u.addEventListener("click",(()=>{s(o,t)}));const _=i.querySelector(".card__like-button");return _.addEventListener("click",(()=>{c(_,e,d)})),n.some((e=>e._id===l))&&_.classList.add("card__like-button_is-active"),console.log(`userId: ${l}, ownerId: ${a}`),console.log(`userId type: ${typeof l}, ownerId type: ${typeof a}`),l!==a?(console.log("Removing delete button"),p.remove()):p.addEventListener("click",(()=>{r(i,e)})),i}function r(o,r,n){((o,r)=>fetch(`${e.baseUrl}/cards/likes/${o}`,{method:r?"DELETE":"PUT",headers:e.headers}).then(t))(r,o.classList.contains("card__like-button_is-active")).then((e=>{o.classList.toggle("card__like-button_is-active"),n.textContent=e.likes.length})).catch((e=>console.log(e)))}function n(o,r){(o=>fetch(`${e.baseUrl}/cards/${o}`,{method:"DELETE",headers:e.headers}).then(t))(r).then((()=>{o.remove()})).catch((e=>{console.log(`Ошибка во время удаления карточки: ${e}`)}))}const c={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},s=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);o.forEach((o=>a(e,o,t))),l(o,r,t)},a=(e,t,o)=>{const r=e.querySelector(`.${t.id}-error`);r?(t.classList.remove(o.inputErrorClass),t.setCustomValidity(""),r.classList.remove(o.errorClass),r.textContent=""):console.error(`Элемент с ошибкой для ${t.id} не найден`)},l=(e,t,o)=>{(e=>e.some((e=>!e.validity.valid)))(e)?(t.disabled=!0,t.classList.add(o.inactiveButtonClass)):(t.disabled=!1,t.classList.remove(o.inactiveButtonClass))};function i(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",d),e.addEventListener("click",p)}function u(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",d),e.removeEventListener("click",p)}function d(e){if("Escape"===e.key){const e=document.querySelector(".popup_is-opened");e&&u(e)}}function p(e){(e.target===e.currentTarget||e.target.classList.contains("popup__close"))&&u(e.currentTarget)}const _=document.querySelector(".places__list"),m=document.querySelectorAll(".popup__close"),y=document.querySelector(".popup_type_new-card"),f=document.querySelector('.popup__form[name="new-place"]'),v=f.querySelector(".popup__input_type_card-name"),h=f.querySelector(".popup__input_type_url"),S=document.querySelector(".profile__add-button"),b=document.querySelector(".popup_type_edit"),q=document.querySelector('.popup__form[name="edit-profile"]'),E=q.querySelector(".popup__input_type_name"),L=q.querySelector(".popup__input_type_description"),g=document.querySelector(".profile__info"),k=g.querySelector(".profile__title"),C=g.querySelector(".profile__description"),$=g.querySelector(".profile__edit-button"),x=document.querySelector(".popup_type_avatar"),A=document.querySelector('.popup__form[name="edit-avatar"]'),w=document.querySelector(".popup__input_type_avatar"),U=document.querySelector(".profile__image"),I=document.querySelector(".popup_type_image"),T=I.querySelector(".popup__image"),B=I.querySelector(".popup__caption");let D=null;function P(e,t){T.src=e,T.alt=t,B.textContent=t,i(I)}function N(e,t){t?_.prepend(e):_.append(e)}const O=(e,t)=>{const o=t.querySelector(".popup__button");e?(o.setAttribute("data-text",o.textContent),o.textContent="Сохранение..."):(o.textContent=o.getAttribute("data-text"),o.removeAttribute("data-text"))};$.addEventListener("click",(()=>{E.value=k.textContent,L.value=C.textContent,s(q,c),i(b)})),S.addEventListener("click",(()=>{f.reset(),s(f,c),i(y)})),U.addEventListener("click",(()=>{A.reset(),s(A,c),i(x)})),m.forEach((e=>{const t=e.closest(".popup");e.addEventListener("click",(()=>{t&&u(t)}))})),q.addEventListener("submit",(function(o){var r,n;o.preventDefault(),O(!0,q),(r=E.value,n=L.value,fetch(`${e.baseUrl}/users/me`,{method:"PATCH",headers:e.headers,body:JSON.stringify({name:r,about:n})}).then(t)).then((e=>{k.textContent=e.name,C.textContent=e.about,u(b)})).catch(console.error).finally((()=>O(!1,q)))})),f.addEventListener("submit",(function(c){var s,a;c.preventDefault(),O(!0,f),(s=v.value,a=h.value,fetch(`${e.baseUrl}/cards`,{method:"POST",headers:e.headers,body:JSON.stringify({name:s,link:a})}).then(t)).then((e=>{console.log(`Созданная карточка. ID владельца: ${e.owner._id}, sessionUserId: ${D}`),N(o(e._id,e.name,e.link,n,e.likes,r,P,e.owner._id,D),!0),f.reset(),u(y)})).catch(console.error).finally((()=>O(!1,f)))})),A.addEventListener("submit",(function(o){var r;o.preventDefault(),O(!0,A),(r=w.value,fetch(`${e.baseUrl}/users/me/avatar`,{method:"PATCH",headers:e.headers,body:JSON.stringify({avatar:r})}).then(t)).then((({avatar:e})=>{U.style.backgroundImage=`url(${e})`,A.reset(),u(x)})).catch(console.error).finally((()=>O(!1,A)))})),Promise.all([fetch(`${e.baseUrl}/users/me`,{headers:e.headers}).then(t),fetch(`${e.baseUrl}/cards`,{headers:e.headers}).then(t)]).then((([e,t])=>{D=e._id,console.log("sessionUserId (загружен с сервера):",D),t.forEach((e=>{console.log(`Карточка загружена. ownerId: ${e.owner._id}, ожидается: ${D}`),N(o(e._id,e.name,e.link,n,e.likes,r,P,e.owner._id,D))}))})).catch(console.error),(e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>((e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);l(o,r,t),o.forEach((n=>{n.addEventListener("input",(()=>{((e,t,o)=>{t.validity.valid?a(e,t,o):((e,t,o,r)=>{const n=e.querySelector(`.${t.id}-error`);t.classList.add(r.inputErrorClass),n.textContent=o,n.classList.add(r.errorClass)})(e,t,t.validationMessage,o)})(e,n,t),l(o,r,t)}))}))})(t,e)))})(c)})();